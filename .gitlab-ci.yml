stages:
  - build
  - deploy

variables:
  NODE_VERSION: "20"

build:
  stage: build
  image: node:${NODE_VERSION}
  script:
    - tar xzf node_modules.tar.gz
    - npm run build
  artifacts:
    paths:
      - dist/
    expire_in: 1 hour

pages:
  stage: deploy
  image: node:${NODE_VERSION}
  script:
    - tar xzf node_modules.tar.gz
    - npm run build
    # GitLab Pages requires output in 'public/' directory
    - rm -rf public
    - mv dist public
  artifacts:
    paths:
      - public/
  only:
    - main

# DEPENDENCY MANAGEMENT:
# node_modules.tar.gz is committed to the repo so CI doesn't need registry access.
# To update dependencies:
#   1. Edit package.json locally
#   2. Run: bash scripts/bundle-deps.sh
#   3. Commit the updated node_modules.tar.gz
#
# NOTE: vite.config.ts has base: '/flowcraft/' for GitHub Pages.
# For GitLab Pages, adjust the base path in vite.config.ts to match your deployment URL.
