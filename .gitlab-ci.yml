stages:
  - build
  - deploy

variables:
  NODE_VERSION: "20"

build:
  stage: build
  image: node:${NODE_VERSION}
  script:
    - tar xzf node_modules.tar.gz
    - chmod +x node_modules/@esbuild/*/bin/* node_modules/@rollup/*/*.node 2>/dev/null || true
    - npx tsc -b && npx vite build --base=/
  artifacts:
    paths:
      - dist/
    expire_in: 1 hour

pages:
  stage: deploy
  image: node:${NODE_VERSION}
  script:
    - tar xzf node_modules.tar.gz
    - chmod +x node_modules/@esbuild/*/bin/* node_modules/@rollup/*/*.node 2>/dev/null || true
    - npx tsc -b && npx vite build --base=/
    # GitLab Pages requires output in 'public/' directory
    - rm -rf public
    - mv dist public
  artifacts:
    paths:
      - public/
  only:
    - main

# DEPENDENCY MANAGEMENT:
# node_modules.tar.gz is committed to the repo so CI doesn't need registry access.
# The tarball includes both Windows and Linux native binaries (rollup, esbuild,
# lightningcss, tailwindcss/oxide) so it works cross-platform.
#
# To update dependencies:
#   1. Edit package.json locally
#   2. Run: bash scripts/bundle-deps.sh   (installs deps + Linux native binaries)
#   3. Commit the updated node_modules.tar.gz alongside package.json/package-lock.json
#
# PERMISSIONS:
# Windows tarballs don't preserve Unix executable bits. The chmod line above
# restores +x on native binaries (esbuild, rollup) after extraction.
#
# BASE PATH:
# vite.config.ts has base: '/flowcraft/' for GitHub Pages.
# GitLab Pages uses --base=/ to override the base path at build time,
# so assets are served from the root (e.g. https://yoursite.gitlab.io/).
